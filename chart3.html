<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FalconWatch Charts</title>
  <link rel="stylesheet" href="./cstyle/chartstyle.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="header">
    <div id="user-info">
      <span id="user-name"></span>
    </div>
    <img src="./img/logoFW.png" alt="Logo" id="logo">
    <div id="nav-buttons">
      <a href="main.html" class="active-link">Home</a>
      <a href="services.html" id="view-services">View Services</a>
      <a href="login.html" id="sign-out" class="sign-out-btn">Sign Out</a>
    </div>
  </div>

  <div class="container">
    <h1>Crime Type vs. Time of Day</h1>
    <div>
      <label for="month">Select Month:</label>
      <select id="month" onchange="fetchCrimeData()">
        <!-- Populate months dynamically -->
      </select>
    </div>
    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>
    <a href="services.html" class="back-btn">Back to Services</a>
  </div>

  <script>
    // Check user role and handle access
    async function checkUserRole() {
      try {
        const userId = localStorage.getItem('userId');

        if (!userId) {
          // No user ID found; redirect to login page
          window.location.href = 'login.html';
          return;
        }

        const roleResponse = await fetch(`/userRole?userId=${userId}`);
        const roleData = await roleResponse.json();
        const role = roleData.role;

        if (role !== 'police') {
          // User is not a police officer; redirect or show error message
          alert('Access denied: You do not have permission to view this page.');
          window.location.href = 'main.html';
          return;
        }

        // User is a police officer; proceed to fetch and display data
        populateMonths();
        fetchCrimeData();
      } catch (error) {
        console.error('Error checking user role:', error);
        alert('An error occurred while checking your role.');
        window.location.href = 'main.html';
      }
    }

    // Populate month options dynamically
    function populateMonths() {
      const months = [
        '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',
        '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12'
      ];
      const select = document.getElementById('month');
      select.innerHTML = '<option value="">All</option>';
      months.forEach(month => {
        select.innerHTML += `<option value="${month}">${new Date(`${month}-01`).toLocaleString('default', { month: 'long', year: 'numeric' })}</option>`;
      });
    }

    let myChart = null;

    async function fetchCrimeData() {
      try {
        const userId = localStorage.getItem('userId');
        const month = document.getElementById('month').value;

        const response = await fetch(`/all-crime-summary?userId=${userId}&month=${month}`);
        const data = await response.json();
        console.log('Fetched data:', data);

        // Convert data to chart format
        const chartData = data.map(item => ({
          x: Number(item.hour),
          y: item.category,
          count: Number(item.count),
          incidentIds: item.incidentIds || []
        }));

        console.log('Chart data:', chartData);

        const chartContainer = document.querySelector('.chart-container');
        let canvas = document.getElementById('myChart');

        if (myChart) {
          myChart.destroy();
        }

        if (data.length === 0) {
          chartContainer.innerHTML = '<p>No crime data available for this period.</p>';
          return; // Exit the function if no data is available
        } else {
          // Ensure canvas element is present
          if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.id = 'myChart';
            canvas.width = 100;
            canvas.height = 100;
            chartContainer.innerHTML = '';
            chartContainer.appendChild(canvas);
          }
        }

        const ctx = canvas.getContext('2d');

        myChart = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Crime Frequency',
              data: chartData,
              backgroundColor: 'rgba(255, 0, 0, 0.6)',
              borderColor: 'rgba(255, 0, 0, 0.6)',
              pointStyle: 'circle',
              radius: 5,
              borderWidth: 1
            }]
          },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  title() { return ''; },
                  label(item) {
                    const dataItem = item.raw;
                    return `Hour: ${dataItem.x}:00, Crime: ${dataItem.y}, Frequency: ${dataItem.count}, IncidentID: ${dataItem.incidentIds.join(', ')}`;
                  }
                }
              }
            },
            scales: {
              x: {
                type: 'linear',
                position: 'bottom',
                title: {
                  display: true,
                  text: 'Time of Day'
                },
                ticks: {
                  callback: function(value) {
                    return `${value}:00`;
                  }
                }
              },
              y: {
                type: 'category',
                labels: ['Theft', 'Assault', 'Robbery', 'Burglary', 'Vandalism'], // Update with actual categories
                title: {
                  display: true,
                  text: 'Crime Type'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error fetching crime data:', error);
      }
    }

    checkUserRole();
  </script>
</body>
</html>