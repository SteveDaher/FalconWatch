<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FalconWatch Crime Report</title>
  <link rel="stylesheet" href="./cstyle/chart2Style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  <div id="header">
    <div id="user-info">
      <span id="user-name"></span>
    </div>
    <img src="./img/logoFW.png" alt="Logo" id="logo">
    <div id="nav-buttons">
      <a href="main.html" class="active-link">Home</a>
      <a href="services.html" id="view-services">View Services</a>
      <a href="login.html" id="sign-out" class="sign-out-btn">Sign Out</a>
    </div>
  </div>

  <div class="container">
    <h1>Crimes Report</h1>
    <div class="chart-wrapper">
      <div class="chart-container">
        <canvas id="categoryChart"></canvas>
      </div>
      <div id="total-crimes-container">
        <h2>Total Crimes this Month:</h2>
        <p id="total-crimes">0</p>
      </div>
    </div>
    <div class="filter-container">
      <label for="monthFilter">Filter by Month:</label>
      <select id="monthFilter">
        <option value="">Select Month</option>
        <option value="2024-01">January 2024</option>
        <option value="2024-02">February 2024</option>
        <option value="2024-03">March 2024</option>
        <option value="2024-04">April 2024</option>
        <option value="2024-05">May 2024</option>
        <option value="2024-06">June 2024</option>
        <option value="2024-07">July 2024</option>
        <option value="2024-08">August 2024</option>
        <option value="2024-09">September 2024</option>
        <option value="2024-10">October 2024</option>
        <option value="2024-11">November 2024</option>
        <option value="2024-12">December 2024</option>
      </select>
      <label for="typeFilter">Filter by Type:</label>
      <select id="typeFilter">
        <option value="category">Category</option>
        <option value="severity">Severity</option>
      </select>
    </div>
    <a href="services.html" class="back-btn">Back to Services</a>
  </div>

  <script>
    let categoryChart;

    const categoryColors = {
  'Willful Murder': '#FF5733',
  'Aggravated Assault': '#33FF57',
  'Rape': '#3357FF',
  'Robbery': '#F1C40F',
  'Theft': '#FF6384',
  'Abduction': '#8E44AD',
  'Burglary': '#FFCE56',
  'Drugs': '#2ECC71',
  'Human Trafficking': '#E74C3C',
  'Other': '#95A5A6'
};

const severityColors = {
  'low': '#4CAF50',    // Green
  'medium': '#FFEB3B', // Yellow
  'high': '#F44336'    // Red
};

async function fetchData(type, month = '') {
  try {
    const userId = localStorage.getItem('userId');
    const roleResponse = await fetch(`/userRole?userId=${userId}`);
    const roleData = await roleResponse.json();
    const role = roleData.role;

    let response;
    if (type === 'category') {
      response = role === 'police'
        ? await fetch(`/crime-summary-category?userId=${userId}&month=${month}`)
        : await fetch(`/crime-summary-category-civilian?userId=${userId}&month=${month}`);
    } else {
      response = role === 'police'
        ? await fetch(`/crime-summary-severity?userId=${userId}&month=${month}`)
        : await fetch(`/crime-summary-severity-civilian?userId=${userId}&month=${month}`);
    }

    const data = await response.json();
    console.log('Fetched data:', data);

    if (!data || data.length === 0) {
      if (categoryChart) {
        categoryChart.destroy();
      }
      updateTotalCrimes(0);
      return;
    }

    const counts = {};
    data.forEach(item => {
      const key = type === 'category' ? item.category : item.severity;
      if (!counts[key]) {
        counts[key] = 0;
      }
      counts[key] += item.count;
    });

    const labels = Object.keys(counts);
    const values = Object.values(counts);

    const colors = labels.map(label => (type === 'category' ? categoryColors[label] : severityColors[label]) || '#999999');
    const borderColors = colors.map(color => color.replace('0.5', '1'));

    if (categoryChart) {
      categoryChart.destroy();
    }

    const ctx = document.getElementById('categoryChart').getContext('2d');
    categoryChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          label: `Crimes by ${type.charAt(0).toUpperCase() + type.slice(1)}`,
          data: values,
          backgroundColor: colors,
          borderColor: borderColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            display: true
          },
          tooltip: {
            callbacks: {
              label: function(tooltipItem) {
                return `${tooltipItem.label}: ${tooltipItem.raw}`;
              }
            }
          },
          datalabels: {
            color: '#000',
            display: true,
            formatter: function(value, context) {
              return context.label;
            },
            anchor: 'center',
            align: 'center',
            font: {
              weight: 'bold',
              size: 12
            }
          }
        }
      }
    });

    const totalCrimes = data.reduce((total, item) => total + item.count, 0);
    updateTotalCrimes(totalCrimes);

  } catch (error) {
    console.error(`Error fetching ${type} data:`, error);
    updateTotalCrimes(0);
  }
}

async function updateTotalCrimes(total) {
  try {
    document.getElementById('total-crimes').textContent = total;
  } catch (error) {
    console.error('Error updating total crimes:', error);
    document.getElementById('total-crimes').textContent = '0';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const currentDate = new Date();
  const currentMonth = String(currentDate.getFullYear()) + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
  document.getElementById('monthFilter').value = currentMonth;
  fetchData('category', currentMonth);

  document.getElementById('monthFilter').addEventListener('change', (event) => {
    const month = event.target.value;
    const type = document.getElementById('typeFilter').value;
    if (month) {
      fetchData(type, month);
    } else {
      if (categoryChart) {
        categoryChart.destroy();
      }
      updateTotalCrimes(0);
    }
  });

  document.getElementById('typeFilter').addEventListener('change', (event) => {
    const type = event.target.value;
    const month = document.getElementById('monthFilter').value;
    if (month) {
      fetchData(type, month);
    } else {
      if (categoryChart) {
        categoryChart.destroy();
      }
      updateTotalCrimes(0);
    }
  });
});

  
  </script>
</body>
</html>
