<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FalconWatch</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css" rel="stylesheet" />
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js'></script>
  <script src="/socket.io/socket.io.js"></script>

  


  <link rel="stylesheet" href="./cstyle/mainStyle.css">
</head>
<body>

  <div id="header">
    <div id="nav-buttons">
        <div id="user-info">
            <img src="./img/free-user-icon-3296-thumb.png" alt="User Icon" id="user-icon">
            <span id="user-name"></span>
            <a href="main.html" class="active-link">Home</a>
            <a href="#">Simulations</a>
            <a href="services.html" id="view-services">View Services</a>

            <!-- Dropdown menu for View Reports -->
            <div class="dropdown">
                <a href="" id="view-reports" class="dropbtn">View Reports</a>
                <ul class="dropdown-content">
                    <li><a href="chart.html">Crime Severity Statistics</a></li>
                    <li><a href="chart2.html">Crime Category Statistics</a></li>
                    <li><a href="chart3.html">Crime Type vs Time of day</a></li>
                    <li><a href="chart4.html">Crime Trends</a></li>

                </ul>
            </div>

           <!-- Dropdown menu for Map Styles -->
        <div class="dropdown">
          <a href="#" id="map-styles" class="dropbtn">Map Styles</a>
          <ul class="dropdown-content">
            <li><a href="#" id="satellite-map">Satellite Map</a></li>
            <li><a href="#" id="white-map">White Map[EN/AE]</a></li>
            <li><a href="#" id="dark-map">Dark Map [EN/AE]</a></li>
            <li><a href="#" id="standard-map">Standard Map</a></li>
            <li><a href="#" id="arabic-map">Street Map[EN/AE]</a></li>

            
          </ul>
        </div>
        

        <!-- Dropdown menu for Language Styles -->
       <div class="dropdown">
       <a href="#" id="Language" class="dropbtn">Language/لغة</a>
        <ul class="dropdown-content">
        <li><a href="#" id="EnglishLanguage">English</a></li>
        <li><a href="#" id="ArabicLanguage">عربي</a></li>
        </ul>
        </div>
            <a href="#" id="toggle-reporting">Report a Crime</a>
        </div>
        <a href="toggle-directions" id="Directions">View Directions</a>

    </div>
    <img src="./img/logoFW.png" alt="Logo" id="logo">
</div>


  
  <div id="map"></div>
  
  <div id="reporting">
    <h2>Report a Crime</h2>
    <form id="crime-report-form">
      <label for="crime-title">Title</label>
      <input type="text" id="crime-title" name="crime-title" required>
      <label for="crime-category">Category</label>
      <select id="crime-category" name="crime-category" required>
        <option value="Willful Murder">Willful Murder</option>
        <option value="Aggravated Assault">Aggravated Assault</option>
        <option value="Rape">Rape</option>
        <option value="Robbery">Robbery</option>
        <option value="Theft">Theft</option>
        <option value="Abduction">Abduction</option>
        <option value="Burglary">Burglary</option>
        <option value="Drugs">Drugs</option>
        <option value="Human Trafficking">Human Trafficking</option>
        <option value="Other">Other</option>
      </select>      
      <label for="crime-description">Description</label>
      <textarea id="crime-description" name="crime-description" required></textarea>
      <label for="crime-coordinates">Coordinates</label>
      <input type="text" id="crime-coordinates" readonly>
      <label for="crime-picture">Picture</label>
      <input type="file" id="crime-picture" name="crime-picture">
      <button type="submit">Submit</button>
    </form>
  </div>

  <div id="timeline-container">
    <div id="timeline-header">
      <h2>Timeline</h2>
      <div id="filter-container">
        <label for="severity-filter">Filter by Severity:</label>
        <select id="severity-filter">
          <option value="all">All</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>
    <div id="timeline">
      <div id="timeline-line"></div>
    </div>
  </div>   

  <div id="toggle-timeline-tab">
    <span id="toggle-arrow">&#9650;</span>
  </div>



  <!-- Success Modal HTML -->
  <div id="success-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <p id="modal-message">Report submitted successfully!</p>
      <p id="modal-timestamp">Date: <span id="timestamp"></span></p>
    </div>
  </div>

  <!-- Picture Modal HTML -->
  <div id="picture-modal" class="modal picture-modal">
    <div class="modal-content picture-modal-content">
      <span class="close">&times;</span>
      <img src="" alt="Crime Picture" id="picture-img">
    </div>
  </div>

  <!-- New Crime Details Popup -->
  <div id="new-crime-details-popup" class="new-modal" onclick="closeNewCrimeDetailsPopup(event)">
    <div class="new-modal-content" onclick="event.stopPropagation()">
      <div id="severity-line"></div> <!-- Severity line at the top -->
      <span class="new-close" onclick="closeNewCrimeDetailsPopup()">&times;</span>
      <div id="new-crime-details-content"></div>
    </div>
  </div>



  <script>

    // Mapbox access token
    mapboxgl.accessToken = 'pk.eyJ1IjoiZmFsY29ud2F0Y2giLCJhIjoiY2x5ZWIwcDJhMDBxbTJqc2VnYWMxeWNvdCJ9.bijpr26vfErYoGhhlQnaFA';

    mapboxgl.setRTLTextPlugin('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js');

  
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/standard',
      center: [55.132327, 25.080857],
      zoom: 15,
      bearing: -50,
      minZoom: 14,
      maxZoom: 18,
    });

    // Retrieve the userId from localStorage after login
  const userId = localStorage.getItem('userId');
  const userName = localStorage.getItem('name'); // Corrected to match the key in localStorage
  const userRole = localStorage.getItem('role'); // Store role in localStorage when the user logs in

  document.addEventListener('DOMContentLoaded', function() {
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('name');
    const userRole = localStorage.getItem('role');

    if (userId && userRole) {
        const socket = io({ query: { userId } });
        console.log('Connected as:', userName, 'with role:', userRole);

        if (userRole === 'police') {
          navigator.geolocation.watchPosition(
    function(position) {
        console.log(`Emitting location for ${userName}:`, position.coords);
        socket.emit('userLocation', {
            coordinates: [position.coords.longitude, position.coords.latitude],
            timestamp: new Date(),
            userName: userName,
            userId: userId // Include userId to ensure unique identification
        });
    },
    function(error) {
        console.error('Error getting location:', error);
    },
    { enableHighAccuracy: true }
);

        }
    } else {
        console.log('User not logged in. Redirecting to login.');
        alert('Please log in to continue.');
        window.location.href = 'login.html';
    }
});


    // Establish connection to the server with userId as a query parameter
    const socket = io({ query: { userId } });

  const policeMarkers = {}; // Object to store markers by userId

  function animateMarker(marker, newCoordinates) {
    const startCoordinates = marker.getLngLat();
    const animationDuration = 1000; // 1 second
    const startTime = performance.now();

    function step(currentTime) {
        const progress = (currentTime - startTime) / animationDuration;

        if (progress < 1) {
            const lng = startCoordinates.lng + (newCoordinates[0] - startCoordinates.lng) * progress;
            const lat = startCoordinates.lat + (newCoordinates[1] - startCoordinates.lat) * progress;
            marker.setLngLat([lng, lat]);
            requestAnimationFrame(step);
        } else {
            marker.setLngLat(newCoordinates); // Ensure it ends at the exact final coordinates
        }
    }

    requestAnimationFrame(step);
}

// Function to update marker position
function updateMarkerPosition(position) {
    console.log('Updating marker position:', position);
    if (userRole !== 'police') {
        console.log('Not a police user. Skipping marker update.');
        return; // Do not track or show the position for non-police users
    }

    const coordinates = [position.coords.longitude, position.coords.latitude];
    const timestamp = new Date();

    if (!policeMarkers[userId]) {
        const popup = new mapboxgl.Popup().setText(`Officer: ${userName}`);
        policeMarkers[userId] = new mapboxgl.Marker({ color: 'blue' })
            .setLngLat(coordinates)
            .setPopup(popup)
            .addTo(map);
        console.log('Created new marker for', userName);
    } else {
        animateMarker(policeMarkers[userId], coordinates);
        console.log('Updated marker position for', userName);
    }

    socket.emit('userLocation', {
        coordinates: coordinates,
        timestamp: timestamp,
        userName: userName
    });

    map.easeTo({ center: coordinates, duration: 1000 });
}


// Handle incoming location updates from other users
socket.on('locationUpdate', (data) => {
    console.log(`Received location update for: ${data.userName}`, data);

    if (userRole !== 'police') {
        return; // Only police should see location updates
    }

    if (data.role !== 'police') {
        return; // Ignore updates from non-police users
    }

    // Check if a marker already exists for this user
    if (!policeMarkers[data.userId]) {
        const popup = new mapboxgl.Popup().setText(`Officer: ${data.userName || 'Unknown'}`);
        policeMarkers[data.userId] = new mapboxgl.Marker({ color: 'red' })
            .setLngLat(data.coordinates)
            .setPopup(popup)
            .addTo(map);
    } else {
        animateMarker(policeMarkers[data.userId], data.coordinates);
    }
});


    let directions; // Declare directions variable outside the event listener
    let isDirectionsVisible = false; // Track the visibility state of the Directions control


   // Event listener for Directions toggle
    document.getElementById('Directions').addEventListener('click', function (event) {
    event.preventDefault(); // Prevent the default anchor behavior

    if (!directions) {
        // Initialize the directions control only if it hasn't been created yet
        directions = new MapboxDirections({
            accessToken: mapboxgl.accessToken
        });
        map.addControl(directions, 'top-left');
        isDirectionsVisible = true;
    } else {
        // Toggle the directions control visibility
        if (isDirectionsVisible) {
            map.removeControl(directions);
        } else {
            map.addControl(directions, 'top-left');
        }
        isDirectionsVisible = !isDirectionsVisible; // Toggle the visibility state
    }
});


 
     // Add event listeners to the Map Styles menu items
     document.getElementById('satellite-map').addEventListener('click', () => {
      map.setStyle('mapbox://styles/mapbox/standard-satellite');
    });

    document.getElementById('white-map').addEventListener('click', () => {
      map.setStyle('mapbox://styles/mapbox/light-v11');
    });

    document.getElementById('dark-map').addEventListener('click', () => {
      map.setStyle('mapbox://styles/mapbox/dark-v11');
    });

    document.getElementById('standard-map').addEventListener('click', () => {
      map.setStyle('mapbox://styles/mapbox/standard');
    });

    document.getElementById('arabic-map').addEventListener('click', () => {
      map.setStyle('mapbox://styles/mapbox/satellite-streets-v11');
    });


    

    let reportsCache = [];
    const markers = {}; // To keep track of markers by their ID
    let currentPin = null; // Variable to store the current pin

    // Toggle the reporting form visibility
    document.getElementById('toggle-reporting').addEventListener('click', function () {
      const reportingDiv = document.getElementById('reporting');
      reportingDiv.style.display = reportingDiv.style.display === 'none' ? 'block' : 'none';
      
      if (reportingDiv.style.display === 'block') {
        // Request user location when the reporting form is shown
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const userLocation = [position.coords.longitude, position.coords.latitude];
            map.setCenter(userLocation);
            map.setZoom(15);
          });
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }
    });

    // Add click event listener to drop a pin
    map.on('click', function (event) {
      const reportingDiv = document.getElementById('reporting');
      
      // Check if the reporting form is visible
      if (reportingDiv.style.display === 'block') {
        const coordinates = [event.lngLat.lng, event.lngLat.lat];

        // Remove the previous pin if it exists
        if (currentPin) {
          currentPin.remove();
        }

        // Add the new pin
        currentPin = new mapboxgl.Marker()
          .setLngLat(coordinates)
          .addTo(map);

        // Autofill coordinates in the form
        document.getElementById('crime-coordinates').value = `${coordinates[0]}, ${coordinates[1]}`;
      }
    });

    // Toggle the timeline visibility
    const toggleTimelineTab = document.getElementById('toggle-timeline-tab');
    const timelineContainer = document.getElementById('timeline-container');
    const toggleArrow = document.getElementById('toggle-arrow');

    toggleTimelineTab.addEventListener('click', function () {
        if (timelineContainer.classList.contains('show')) {
            timelineContainer.classList.remove('show');
            timelineContainer.style.transform = 'translateY(100%)';
            toggleTimelineTab.style.bottom = '0px'; 
            toggleArrow.style.transform = 'rotate(0deg)';
        } else {
            timelineContainer.classList.add('show');
            timelineContainer.style.transform = 'translateY(0)';
            toggleTimelineTab.style.bottom = '153px'; 
            toggleArrow.style.transform = 'rotate(180deg)';
        }
    });

    function getDubaiTimeOfDay() {
  // Create a new Date object for the current time
  const now = new Date();

  // Use Intl.DateTimeFormat to format the date to the Dubai time zone
  const options = { timeZone: 'Asia/Dubai', hour: '2-digit', hour12: false };
  const formatter = new Intl.DateTimeFormat([], options);
  const dubaiTime = formatter.formatToParts(now);
  
  // Extract the hours part from the formatted date
  const hours = parseInt(dubaiTime.find(part => part.type === 'hour').value);
  console.log(`Dubai Time: ${now.toLocaleString('en-US', { timeZone: 'Asia/Dubai' })}, Hours: ${hours}`); // Debugging log

  if (hours >= 5 && hours < 8) {
    return 'dawn';
  } else if (hours >= 8 && hours < 15) {
    return 'day';
  } else if (hours >= 15 && hours < 20) {
    return 'dusk';
  } else {
    return 'night';
  }
}

function setMapLightBasedOnTime() {
  const timeOfDay = getDubaiTimeOfDay();
  let lightPreset = '';

  switch (timeOfDay) {
    case 'dawn':
      lightPreset = 'dawn';
      break;
    case 'day':
      lightPreset = 'day';
      break;
    case 'dusk':
      lightPreset = 'dusk';
      break;
    case 'night':
      lightPreset = 'night';
      break;
    default:
      lightPreset = 'day'; // Default to 'day' if the timeOfDay is unrecognized
  }

  console.log(`Applying light preset for ${timeOfDay}: ${lightPreset}`); // Debugging log

  if (map.isStyleLoaded()) {
    map.setConfigProperty('basemap', 'lightPreset', lightPreset);
  } else {
    map.on('style.load', () => {
      map.setConfigProperty('basemap', 'lightPreset', lightPreset);
    });
  }
}


// Add Mapbox Language plugin
const language = new MapboxLanguage();
map.addControl(language);

function setMapLanguage(language) {
    console.log(`Setting map language to: ${language}`);
    map.getStyle().layers.forEach((layer) => {
        if (layer.layout && layer.layout['text-field']) {
            console.log(`Updating layer: ${layer.id}`);
            map.setLayoutProperty(layer.id, 'text-field', [
                'get',
                `name_${language}`
            ]);
        }
    });
}
// Language switching logic
document.getElementById('EnglishLanguage').addEventListener('click', () => {
    console.log('English selected');
    setMapLanguage('en');
});

document.getElementById('ArabicLanguage').addEventListener('click', () => {
    console.log('Arabic selected');
    setMapLanguage('ar');
});


function promptLocationPermission() {
    // Check if the browser supports geolocation
    if (navigator.geolocation) {
        // Check if the user has granted location permissions
        navigator.permissions.query({ name: 'geolocation' }).then(function(permissionStatus) {
            if (permissionStatus.state === 'granted') {
                console.log('Location access granted.');
                // Store the user's location to localStorage or handle it as needed
                localStorage.setItem('locationShared', 'true');
            } else if (permissionStatus.state === 'prompt') {
                // Request location access
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('Location access granted.');
                        // Store the user's location to localStorage or handle it as needed
                        localStorage.setItem('locationShared', 'true');
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                        // Handle errors (e.g., user denies permission)
                        if (error.code === error.PERMISSION_DENIED) {
                            alert("Location access denied. Some features may not work.");
                            console.log('User denied location access.');
                        }
                    }
                );
            } else {
                console.log('Location access denied.');
                alert("Location access is denied. Some features may not work.");
            }
        }).catch(function(error) {
            console.error('Error querying permissions:', error);
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}
    // Load map.geojson as a source
    map.on('load', async function () {
     map.setConfigProperty('basemap', 'showPointOfInterestLabels', true);
     map.setConfigProperty('basemap', 'showRoadLabels	', true);
     
 
     setMapLightBasedOnTime();
     setInterval(setMapLightBasedOnTime, 0.1 * 60 * 1000);

     setMapLanguage('en');
     


      map.addSource('boundary', {
        type: 'geojson',
        data: 'map.geojson'
      });
  
      map.addLayer({
        id: 'boundary-layer',
        type: 'line',
        source: 'boundary',
        layout: {},
        paint: {
          'line-color': '#ff0000',
          'line-width': 2
        }
      });
  
   
      // Fetch and display existing reports
      await fetchReports();
  
      // Check URL for showPin parameter
      const params = new URLSearchParams(window.location.search);
      const showPinId = params.get('showPin');
      if (showPinId) {
        const marker = markers[showPinId];
        if (marker) {
          map.flyTo({ center: marker.getLngLat(), zoom: 17 });
          marker.togglePopup();
        }
      }

      if (!localStorage.getItem('locationShared')) {
        promptLocationPermission();
    }

    });


    // Function to fetch and display reports
    async function fetchReports() {
      const userId = localStorage.getItem('userId'); // Assuming the userId is stored in localStorage after login
      console.log('Retrieved userId from localStorage:', userId); // Debug: log the retrieved userId
      try {
        // Fetch user role
        const userResponse = await fetch(`/userRole?userId=${userId}`);
        const user = await userResponse.json();
        const role = user.role;
        document.getElementById('user-name').textContent = user.name;

        let reports = [];
        if (role === 'police') {
          const response = await fetch(`/all-reports?userId=${userId}`);
          reports = await response.json();
        } else {
          const response = await fetch(`/reports?userId=${userId}`);
          reports = await response.json();
        }

        reportsCache = reports;
        reports.forEach(report => addReportToMap(report));
        addReportsToTimeline(reports);
      } catch (error) {
        console.error('Error fetching reports:', error);
      }
    }

   

    function addReportToMap(report) {
      if (!report.coordinates || !Array.isArray(report.coordinates) || report.coordinates.length !== 2) {
        console.error('Invalid coordinates:', report.coordinates);
        return;
      }

      const markerColor = getMarkerColor(report.severity);
      const popupContent = `
        <h3>Incident ID: ${report.incidentId}</h3>
        <h4>${report.name || 'No Title Provided'}</h4> <!-- Default to 'No Title Provided' if name is undefined -->
        <p><strong>Category:</strong> ${report.category}</p>
        <p><strong>Description:</strong> ${report.description}</p>
        <p><strong>Severity:</strong> ${report.severity}</p>
        <p><strong>Date:</strong> ${formatDate(new Date(report.date))}</p>
        ${report.picture ? `<img src="${report.picture}" alt="Crime Picture" style="max-width: 100%; height: auto;">` : ''}
      `;
      const popup = new mapboxgl.Popup().setHTML(popupContent);

      const el = document.createElement('div');
      el.className = 'custom-marker';
      
      if (report.severity.toLowerCase() === 'high') {
        el.classList.add('red-marker', 'pulse');
      }

      el.style.backgroundColor = markerColor;
      el.dataset.incidentId = report.incidentId;
      el.dataset.coordinates = report.coordinates.join(',');

      const marker = new mapboxgl.Marker(el)
        .setLngLat(report.coordinates)
        .setPopup(popup)
        .addTo(map);

      markers[report.incidentId] = marker; // Save marker by ID
    }

    function addReportsToTimeline(reports) {
      const timeline = document.getElementById('timeline');
      const dateMarkers = {}; // Track date markers

      reports.forEach(report => {
        const dot = document.createElement('div');
        dot.className = 'timeline-dot';
        dot.dataset.severity = report.severity.toLowerCase();
        dot.dataset.incidentId = report.incidentId;

        const severityColor = getSeverityColor(report.severity);
        dot.style.backgroundColor = severityColor;

        dot.addEventListener('click', () => {
          showNewCrimeDetailsPopup(report);
        });

        const reportDate = new Date(report.date);
        const reportDay = reportDate.toISOString().split('T')[0];
        dot.dataset.date = reportDay; // Add date data attribute

        // Create a date marker if it doesn't already exist
        if (!dateMarkers[reportDay]) {
          const dateMarker = document.createElement('div');
          dateMarker.className = 'timeline-date-marker';
          dateMarker.dataset.date = reportDay; // Set data-date attribute
          dateMarker.innerHTML = `<div class="timeline-date"><span>${reportDate.getDate()} ${reportDate.toLocaleString('default', { month: 'short' })}</span></div>`;
          dateMarkers[reportDay] = dateMarker;
          timeline.appendChild(dateMarker);
        }

        timeline.appendChild(dot);
      });

      // Adjust date markers positions
      Object.values(dateMarkers).forEach(dateMarker => {
        const date = dateMarker.dataset.date;
        const dots = document.querySelectorAll(`.timeline-dot[data-date="${date}"]`);
        if (dots.length > 0) {
          dateMarker.style.left = dots[0].offsetLeft + 'px';
        }
      });
    }

    document.getElementById('severity-filter').addEventListener('change', function() {
      const selectedSeverity = this.value;
      const timelineItems = document.querySelectorAll('.timeline-dot');
      const dateMarkers = document.querySelectorAll('.timeline-date-marker');

      timelineItems.forEach(item => {
        if (selectedSeverity === 'all' || item.dataset.severity === selectedSeverity) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });

      dateMarkers.forEach(marker => {
        const date = marker.dataset.date;
        const dots = document.querySelectorAll(`.timeline-dot[data-date="${date}"]:not([style*="display: none"])`);
        if (dots.length > 0) {
          marker.style.display = 'block';
        } else {
          marker.style.display = 'none';
        }
      });
    });

    function getMarkerColor(severity) {
      switch (severity.toLowerCase()) {
        case 'high': return '#df0000';
        case 'medium': return '#FFFF00';
        case 'low': return '#00FF00';
        default: return 'gray';
      }
    }

    function getSeverityColor(severity) {
      switch (severity.toLowerCase()) {
        case 'high': return '#df0000';
        case 'medium': return '#FFFF00';
        case 'low': return '#00FF00';
        default: return 'gray';
      }
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function showNewCrimeDetailsPopup(report) {
      const crimeDetailsContent = document.getElementById('new-crime-details-content');
      const severityColor = getSeverityColor(report.severity); // Get the severity color
      document.getElementById('severity-line').style.backgroundColor = severityColor; // Set the severity line color

      crimeDetailsContent.innerHTML = `
        <h3>Incident ID: ${report.incidentId}</h3>
        <h4>${report.name || 'No Title Provided'}</h4>
        <p><strong>Category:</strong> ${report.category}</p>
        <p><strong>Description:</strong> ${report.description}</p>
        <p><strong>Severity:</strong> ${report.severity}</p>
        <p><strong>Date:</strong> ${formatDate(new Date(report.date))}</p>
        ${report.picture ? `<img src="${report.picture}" alt="Crime Picture" style="max-width: 100%; height: auto;">` : ''}
      `;
      const crimeDetailsPopup = document.getElementById('new-crime-details-popup');
      crimeDetailsPopup.style.display = 'block';
    }

    function closeNewCrimeDetailsPopup(event) {
      if (event && event.target !== document.getElementById('new-crime-details-popup')) return;
      const crimeDetailsPopup = document.getElementById('new-crime-details-popup');
      crimeDetailsPopup.style.display = 'none';
    }

    document.getElementById('crime-report-form').addEventListener('submit', async function(event) {
      event.preventDefault(); // Prevent the default form submission
  
      const userId = localStorage.getItem('userId'); // Assuming the userId is stored in localStorage after login
      const name = document.getElementById('crime-title').value; // Change `title` to `name`
      const category = document.getElementById('crime-category').value;
      const description = document.getElementById('crime-description').value;
      const coordinates = document.getElementById('crime-coordinates').value;
  
      const [lng, lat] = coordinates.split(',').map(Number);
  
      if (isNaN(lng) || isNaN(lat)) {
        alert('Please enter valid coordinates.');
        return;
      }
  
      const crimePicture = document.getElementById('crime-picture').files[0];
      let pictureData = '';
      if (crimePicture) {
        pictureData = await toBase64(crimePicture);
      }
  
      const crimeReport = {
        name, // Updated field name here
        category,
        description,
        coordinates: [lng, lat],
        picture: pictureData,
        userId // Include userId in the report data
      };
  
      console.log('Submitting report with userId:', userId); // Debug: log the userId being submitted
  
      try {
        const response = await fetch('/report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(crimeReport),
        });
  
        if (!response.ok) throw new Error('Network response was not ok');
  
        const result = await response.json();
  
        reportsCache.push(result);
        addReportToMap(result);
        addReportsToTimeline(reportsCache);
  
        showModal('Report submitted successfully!', formatDate(new Date(result.date)));
  
        // Close the reporting form
        document.getElementById('reporting').style.display = 'none';
      } catch (error) {
        console.error('Error submitting report:', error);
        showModal('Failed to submit report.');
      }
  
      // Reset the form after submission
      document.getElementById('crime-report-form').reset();
    });

    // Function to convert file to base64
    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Function to show modal
    function showModal(message, timestamp) {
      const successModal = document.getElementById('success-modal');
      document.getElementById('modal-message').textContent = message;
      if (timestamp) {
        document.getElementById('timestamp').textContent = timestamp;
      }

      successModal.style.display = 'block';

      // Close modal when user clicks on (x)
      document.querySelector('.close').addEventListener('click', function() {
        successModal.style.display = 'none';
      });

      // Close modal when user clicks anywhere outside of the modal
      window.addEventListener('click', function(event) {
        if (event.target === successModal) {
          successModal.style.display = 'none';
        }
      });
    }

    // Function to view picture in a modal
    function viewPicture(pictureUrl) {
      const pictureModal = document.getElementById('picture-modal');
      document.getElementById('picture-img').src = pictureUrl;
      pictureModal.style.display = 'block';

      // Close modal when user clicks on (x)
      document.querySelector('#picture-modal .close').addEventListener('click', function() {
        pictureModal.style.display = 'none';
      });

      // Close modal when user clicks anywhere outside of the modal
      window.addEventListener('click', function(event) {
        if (event.target === pictureModal) {
          pictureModal.style.display = 'none';
        }
      });
    }


    

  </script>
</body>
</html>
