<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FalconWatch</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
  <link rel="stylesheet" href="./cstyle/mainStyle.css">
</head>
<body>

  <div id="header">
    <div id="nav-buttons">
      <a href="main.html" class="active-link">Home</a>
      <a href="#">Simulations</a>
      <a href="services.html" id="view-services">View Services</a>
      <a href="#" id="toggle-reporting">Report a Crime</a>
      <div id="user-info">
        <img src="./img/user-icon.png" alt="User Icon" id="user-icon">
        <span id="user-name"></span>
        <a href="login.html" id="sign-out" class="sign-out-btn">Sign Out</a>
      </div>
    </div>
    <img src="./img/logoFW.png" alt="Logo" id="logo">
  </div>
  
  <div id="map"></div>
  
  <div id="reporting">
    <h2>Report a Crime</h2>
    <form id="crime-report-form">
      <label for="crime-title">Title</label>
      <input type="text" id="crime-title" name="crime-title" required>
      <label for="crime-category">Category</label>
      <select id="crime-category" name="crime-category" required>
        <option value="Willful Murder">Willful Murder</option>
        <option value="Aggravated Assault">Aggravated Assault</option>
        <option value="Rape">Rape</option>
        <option value="Robbery">Robbery</option>
        <option value="Theft">Theft</option>
        <option value="Abduction">Abduction</option>
        <option value="Burglary">Burglary</option>
        <option value="Drugs">Drugs</option>
        <option value="Human Trafficking">Human Trafficking</option>
        <option value="Other">Other</option>
      </select>      
      <label for="crime-description">Description</label>
      <textarea id="crime-description" name="crime-description" required></textarea>
      <label for="crime-coordinates">Coordinates</label>
      <input type="text" id="crime-coordinates" readonly>
      <label for="crime-picture">Picture</label>
      <input type="file" id="crime-picture" name="crime-picture">
      <button type="submit">Submit</button>
    </form>
  </div>

  <div id="timeline-container">
    <div id="timeline-header">
      <h2>Timeline</h2>
      <div id="filter-container">
        <label for="severity-filter">Filter by Severity:</label>
        <select id="severity-filter">
          <option value="all">All</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>
    <div id="timeline">
      <div id="timeline-line"></div>
    </div>
  </div>   

  <div id="toggle-timeline-tab">
    <span id="toggle-arrow">&#9650;</span>
  </div>

  <!-- Success Modal HTML -->
  <div id="success-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <p id="modal-message">Report submitted successfully!</p>
      <p id="modal-timestamp">Date: <span id="timestamp"></span></p>
    </div>
  </div>

  <!-- Picture Modal HTML -->
  <div id="picture-modal" class="modal picture-modal">
    <div class="modal-content picture-modal-content">
      <span class="close">&times;</span>
      <img src="" alt="Crime Picture" id="picture-img">
    </div>
  </div>

  <!-- New Crime Details Popup -->
  <div id="new-crime-details-popup" class="new-modal" onclick="closeNewCrimeDetailsPopup(event)">
    <div class="new-modal-content" onclick="event.stopPropagation()">
      <div id="severity-line"></div> <!-- Severity line at the top -->
      <span class="new-close" onclick="closeNewCrimeDetailsPopup()">&times;</span>
      <div id="new-crime-details-content"></div>
    </div>
  </div>

  <script>
    // Mapbox access token
    mapboxgl.accessToken = 'pk.eyJ1IjoiZmFsY29ud2F0Y2giLCJhIjoiY2x5ZWIwcDJhMDBxbTJqc2VnYWMxeWNvdCJ9.bijpr26vfErYoGhhlQnaFA';
  
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/standard',
      center: [55.132327, 25.080857],
      zoom: 15,
      bearing: -50,
      minZoom: 14,
      maxZoom: 18,
    });
  
    let reportsCache = [];
    const markers = {}; // To keep track of markers by their ID
    let currentPin = null; // Variable to store the current pin

    // Toggle the reporting form visibility
    document.getElementById('toggle-reporting').addEventListener('click', function () {
      const reportingDiv = document.getElementById('reporting');
      reportingDiv.style.display = reportingDiv.style.display === 'none' ? 'block' : 'none';
      
      if (reportingDiv.style.display === 'block') {
        // Request user location when the reporting form is shown
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const userLocation = [position.coords.longitude, position.coords.latitude];
            map.setCenter(userLocation);
            map.setZoom(15);
          });
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }
    });

    // Add click event listener to drop a pin
    map.on('click', function (event) {
      const reportingDiv = document.getElementById('reporting');
      
      // Check if the reporting form is visible
      if (reportingDiv.style.display === 'block') {
        const coordinates = [event.lngLat.lng, event.lngLat.lat];

        // Remove the previous pin if it exists
        if (currentPin) {
          currentPin.remove();
        }

        // Add the new pin
        currentPin = new mapboxgl.Marker()
          .setLngLat(coordinates)
          .addTo(map);

        // Autofill coordinates in the form
        document.getElementById('crime-coordinates').value = `${coordinates[0]}, ${coordinates[1]}`;
      }
    });

    // Toggle the timeline visibility
    const toggleTimelineTab = document.getElementById('toggle-timeline-tab');
    const timelineContainer = document.getElementById('timeline-container');
    const toggleArrow = document.getElementById('toggle-arrow');

    toggleTimelineTab.addEventListener('click', function () {
        if (timelineContainer.classList.contains('show')) {
            timelineContainer.classList.remove('show');
            timelineContainer.style.transform = 'translateY(100%)';
            toggleTimelineTab.style.bottom = '0px'; 
            toggleArrow.style.transform = 'rotate(0deg)';
        } else {
            timelineContainer.classList.add('show');
            timelineContainer.style.transform = 'translateY(0)';
            toggleTimelineTab.style.bottom = '153px'; 
            toggleArrow.style.transform = 'rotate(180deg)';
        }
    });

    // Load map.geojson as a source
    map.on('load', async function () {
      map.addSource('boundary', {
        type: 'geojson',
        data: 'map.geojson'
      });
  
      map.addLayer({
        id: 'boundary-layer',
        type: 'line',
        source: 'boundary',
        layout: {},
        paint: {
          'line-color': '#ff0000',
          'line-width': 2
        }
      });
  
      // Fetch and display existing reports
      await fetchReports();
  
      // Check URL for showPin parameter
      const params = new URLSearchParams(window.location.search);
      const showPinId = params.get('showPin');
      if (showPinId) {
        const marker = markers[showPinId];
        if (marker) {
          map.flyTo({ center: marker.getLngLat(), zoom: 17 });
          marker.togglePopup();
        }
      }
    });

    // Function to fetch and display reports
    async function fetchReports() {
      const userId = localStorage.getItem('userId'); // Assuming the userId is stored in localStorage after login
      console.log('Retrieved userId from localStorage:', userId); // Debug: log the retrieved userId
      try {
        // Fetch user role
        const userResponse = await fetch(`/userRole?userId=${userId}`);
        const user = await userResponse.json();
        const role = user.role;
        document.getElementById('user-name').textContent = user.name;

        let reports = [];
        if (role === 'police') {
          const response = await fetch(`/all-reports?userId=${userId}`);
          reports = await response.json();
        } else {
          const response = await fetch(`/reports?userId=${userId}`);
          reports = await response.json();
        }

        reportsCache = reports;
        reports.forEach(report => addReportToMap(report));
        addReportsToTimeline(reports);
      } catch (error) {
        console.error('Error fetching reports:', error);
      }
    }
  
    function addReportToMap(report) {
      if (!report.coordinates || !Array.isArray(report.coordinates) || report.coordinates.length !== 2) {
        console.error('Invalid coordinates:', report.coordinates);
        return;
      }

      const markerColor = getMarkerColor(report.severity);
      const popupContent = `
        <h3>Incident ID: ${report.incidentId}</h3>
        <h4>${report.name || 'No Title Provided'}</h4> <!-- Default to 'No Title Provided' if name is undefined -->
        <p><strong>Category:</strong> ${report.category}</p>
        <p><strong>Description:</strong> ${report.description}</p>
        <p><strong>Severity:</strong> ${report.severity}</p>
        <p><strong>Date:</strong> ${formatDate(new Date(report.date))}</p>
        ${report.picture ? `<img src="${report.picture}" alt="Crime Picture" style="max-width: 100%; height: auto;">` : ''}
      `;
      const popup = new mapboxgl.Popup().setHTML(popupContent);

      const el = document.createElement('div');
      el.className = 'custom-marker';
      
      if (report.severity.toLowerCase() === 'high') {
        el.classList.add('red-marker', 'pulse');
      }

      el.style.backgroundColor = markerColor;
      el.dataset.incidentId = report.incidentId;
      el.dataset.coordinates = report.coordinates.join(',');

      const marker = new mapboxgl.Marker(el)
        .setLngLat(report.coordinates)
        .setPopup(popup)
        .addTo(map);

      markers[report.incidentId] = marker; // Save marker by ID
    }

    function addReportsToTimeline(reports) {
      const timeline = document.getElementById('timeline');
      const dateMarkers = {}; // Track date markers

      reports.forEach(report => {
        const dot = document.createElement('div');
        dot.className = 'timeline-dot';
        dot.dataset.severity = report.severity.toLowerCase();
        dot.dataset.incidentId = report.incidentId;

        const severityColor = getSeverityColor(report.severity);
        dot.style.backgroundColor = severityColor;

        dot.addEventListener('click', () => {
          showNewCrimeDetailsPopup(report);
        });

        const reportDate = new Date(report.date);
        const reportDay = reportDate.toISOString().split('T')[0];
        dot.dataset.date = reportDay; // Add date data attribute

        // Create a date marker if it doesn't already exist
        if (!dateMarkers[reportDay]) {
          const dateMarker = document.createElement('div');
          dateMarker.className = 'timeline-date-marker';
          dateMarker.dataset.date = reportDay; // Set data-date attribute
          dateMarker.innerHTML = `<div class="timeline-date"><span>${reportDate.getDate()} ${reportDate.toLocaleString('default', { month: 'short' })}</span></div>`;
          dateMarkers[reportDay] = dateMarker;
          timeline.appendChild(dateMarker);
        }

        timeline.appendChild(dot);
      });

      // Adjust date markers positions
      Object.values(dateMarkers).forEach(dateMarker => {
        const date = dateMarker.dataset.date;
        const dots = document.querySelectorAll(`.timeline-dot[data-date="${date}"]`);
        if (dots.length > 0) {
          dateMarker.style.left = dots[0].offsetLeft + 'px';
        }
      });
    }

    document.getElementById('severity-filter').addEventListener('change', function() {
      const selectedSeverity = this.value;
      const timelineItems = document.querySelectorAll('.timeline-dot');
      const dateMarkers = document.querySelectorAll('.timeline-date-marker');

      timelineItems.forEach(item => {
        if (selectedSeverity === 'all' || item.dataset.severity === selectedSeverity) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });

      dateMarkers.forEach(marker => {
        const date = marker.dataset.date;
        const dots = document.querySelectorAll(`.timeline-dot[data-date="${date}"]:not([style*="display: none"])`);
        if (dots.length > 0) {
          marker.style.display = 'block';
        } else {
          marker.style.display = 'none';
        }
      });
    });

    function getMarkerColor(severity) {
      switch (severity.toLowerCase()) {
        case 'high': return '#df0000';
        case 'medium': return '#FFFF00';
        case 'low': return '#00FF00';
        default: return 'gray';
      }
    }

    function getSeverityColor(severity) {
      switch (severity.toLowerCase()) {
        case 'high': return '#df0000';
        case 'medium': return '#FFFF00';
        case 'low': return '#00FF00';
        default: return 'gray';
      }
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function showNewCrimeDetailsPopup(report) {
      const crimeDetailsContent = document.getElementById('new-crime-details-content');
      const severityColor = getSeverityColor(report.severity); // Get the severity color
      document.getElementById('severity-line').style.backgroundColor = severityColor; // Set the severity line color

      crimeDetailsContent.innerHTML = `
        <h3>Incident ID: ${report.incidentId}</h3>
        <h4>${report.name || 'No Title Provided'}</h4>
        <p><strong>Category:</strong> ${report.category}</p>
        <p><strong>Description:</strong> ${report.description}</p>
        <p><strong>Severity:</strong> ${report.severity}</p>
        <p><strong>Date:</strong> ${formatDate(new Date(report.date))}</p>
        ${report.picture ? `<img src="${report.picture}" alt="Crime Picture" style="max-width: 100%; height: auto;">` : ''}
      `;
      const crimeDetailsPopup = document.getElementById('new-crime-details-popup');
      crimeDetailsPopup.style.display = 'block';
    }

    function closeNewCrimeDetailsPopup(event) {
      if (event && event.target !== document.getElementById('new-crime-details-popup')) return;
      const crimeDetailsPopup = document.getElementById('new-crime-details-popup');
      crimeDetailsPopup.style.display = 'none';
    }

    document.getElementById('crime-report-form').addEventListener('submit', async function(event) {
      event.preventDefault(); // Prevent the default form submission
  
      const userId = localStorage.getItem('userId'); // Assuming the userId is stored in localStorage after login
      const name = document.getElementById('crime-title').value; // Change `title` to `name`
      const category = document.getElementById('crime-category').value;
      const description = document.getElementById('crime-description').value;
      const coordinates = document.getElementById('crime-coordinates').value;
  
      const [lng, lat] = coordinates.split(',').map(Number);
  
      if (isNaN(lng) || isNaN(lat)) {
        alert('Please enter valid coordinates.');
        return;
      }
  
      const crimePicture = document.getElementById('crime-picture').files[0];
      let pictureData = '';
      if (crimePicture) {
        pictureData = await toBase64(crimePicture);
      }
  
      const crimeReport = {
        name, // Updated field name here
        category,
        description,
        coordinates: [lng, lat],
        picture: pictureData,
        userId // Include userId in the report data
      };
  
      console.log('Submitting report with userId:', userId); // Debug: log the userId being submitted
  
      try {
        const response = await fetch('/report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(crimeReport),
        });
  
        if (!response.ok) throw new Error('Network response was not ok');
  
        const result = await response.json();
  
        reportsCache.push(result);
        addReportToMap(result);
        addReportsToTimeline(reportsCache);
  
        showModal('Report submitted successfully!', formatDate(new Date(result.date)));
  
        // Close the reporting form
        document.getElementById('reporting').style.display = 'none';
      } catch (error) {
        console.error('Error submitting report:', error);
        showModal('Failed to submit report.');
      }
  
      // Reset the form after submission
      document.getElementById('crime-report-form').reset();
    });

    // Function to convert file to base64
    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Function to show modal
    function showModal(message, timestamp) {
      const successModal = document.getElementById('success-modal');
      document.getElementById('modal-message').textContent = message;
      if (timestamp) {
        document.getElementById('timestamp').textContent = timestamp;
      }

      successModal.style.display = 'block';

      // Close modal when user clicks on (x)
      document.querySelector('.close').addEventListener('click', function() {
        successModal.style.display = 'none';
      });

      // Close modal when user clicks anywhere outside of the modal
      window.addEventListener('click', function(event) {
        if (event.target === successModal) {
          successModal.style.display = 'none';
        }
      });
    }

    // Function to view picture in a modal
    function viewPicture(pictureUrl) {
      const pictureModal = document.getElementById('picture-modal');
      document.getElementById('picture-img').src = pictureUrl;
      pictureModal.style.display = 'block';

      // Close modal when user clicks on (x)
      document.querySelector('#picture-modal .close').addEventListener('click', function() {
        pictureModal.style.display = 'none';
      });

      // Close modal when user clicks anywhere outside of the modal
      window.addEventListener('click', function(event) {
        if (event.target === pictureModal) {
          pictureModal.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
