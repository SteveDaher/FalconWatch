<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FalconWatch Charts</title>
  <link rel="stylesheet" href="./cstyle/chartstyle.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="header">
    <div id="user-info">
      <span id="user-name"></span>
    </div>
    <img src="./img/logoFW.png" alt="Logo" id="logo">
    <div id="nav-buttons">
      <a href="main.html" class="active-link">Home</a>
      <a href="services.html" id="view-services">View Services</a>
      <a href="login.html" id="sign-out" class="sign-out-btn">Sign Out</a>
    </div>
  </div>

  <div class="container">
    <h1>Crime Severity Report</h1>
    <div class="chart-container">
      <canvas id="myBarChart"></canvas>
    </div>
    <a href="services.html" class="back-btn">Back to Services</a>
  </div>

  <script>
    async function fetchCrimeData() {
      try {
        const userId = localStorage.getItem('userId');
        console.log('Retrieved userId from localStorage:', userId);
  
        const roleResponse = await fetch(`/userRole?userId=${userId}`);
        const roleData = await roleResponse.json();
        const role = roleData.role;
  
        let response;
        if (role === 'police') {
          response = await fetch(`/all-crime-summary?userId=${userId}`);
        } else {
          response = await fetch(`/crime-summary?userId=${userId}`);
        }
  
        const data = await response.json();
        console.log('Fetched data:', data);
  
        const monthlyData = {};
        data.forEach(item => {
          const month = `${item.year}-${item.month.toString().padStart(2, '0')}`;
          if (!monthlyData[month]) {
            monthlyData[month] = { low: 0, medium: 0, high: 0 };
          }
          // Accumulate counts
          monthlyData[month][item.severity] += item.count;
        });
  
        const labels = Object.keys(monthlyData);
        const lowData = labels.map(month => monthlyData[month].low || 0);
        const mediumData = labels.map(month => monthlyData[month].medium || 0);
        const highData = labels.map(month => monthlyData[month].high || 0);
  
        const ctx = document.getElementById('myBarChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Low Severity',
                data: lowData,
                backgroundColor: 'rgba(76, 175, 80, 0.5)',
                borderColor: 'rgba(76, 175, 80, 1)',
                borderWidth: 1,
                barThickness: 10
              },
              {
                label: 'Medium Severity',
                data: mediumData,
                backgroundColor: 'rgba(255, 235, 59, 0.5)',
                borderColor: 'rgba(255, 235, 59, 1)',
                borderWidth: 1,
                barThickness: 10
              },
              {
                label: 'High Severity',
                data: highData,
                backgroundColor: 'rgba(244, 67, 54, 0.5)',
                borderColor: 'rgba(244, 67, 54, 1)',
                borderWidth: 1,
                barThickness: 10
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(tooltipItem) {
                    return `${tooltipItem.dataset.label}: ${tooltipItem.raw}`;
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Month'
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Crimes'
                }
              }
            }
          }
        });
  
        if (data.length === 0) {
          document.querySelector('.chart-container').innerHTML = '<p>No crime data available for this period.</p>';
        }
      } catch (error) {
        console.error('Error fetching crime data:', error);
      }
    }
  
    fetchCrimeData();
  </script>
</body>
</html>
